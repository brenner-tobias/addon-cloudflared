#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Cloudflared
# Take down the S6 supervision tree when Caddy fails
# ==============================================================================

# Avoid halting container if the built-in proxy was not enabled
if [[ ! -f /dev/shm/use_built_in_proxy ]]; then
    exit 0
fi

readonly exit_code_service="${1}"
readonly exit_code_signal="${2}"
exit_code_container=$(cat /run/s6-linux-init-container-results/exitcode)
readonly exit_code_container
readonly service="caddy"

bashio::log.info \
    "Service ${service} exited with code ${exit_code_service}" \
    "(by signal ${exit_code_signal})"

if [[ "${exit_code_service}" -eq 256 ]]; then
    if [[ "${exit_code_container}" -eq 0 ]]; then
        echo $((128 + exit_code_signal)) >/run/s6-linux-init-container-results/exitcode
    fi
    if [[ "${exit_code_signal}" -eq 15 ]]; then
        exec /run/s6/basedir/bin/halt
    fi
elif [[ "${exit_code_service}" -ne 0 ]]; then
    if [[ "${exit_code_container}" -eq 0 ]]; then
        echo "${exit_code_service}" >/run/s6-linux-init-container-results/exitcode
    fi
    exec /run/s6/basedir/bin/halt
fi
