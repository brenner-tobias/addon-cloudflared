#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Cloudflared
#
# Configures the nginx service as workaround to get live streaming logs working
# see https://github.com/brenner-tobias/addon-cloudflared/discussions/744
# ==============================================================================
# set up and run nginx
# ==============================================================================

if bashio::config.false 'use_builtin_proxy'; then
    bashio::log.info "Using Cloudflared without the built-in NGINX proxy"
    # Send a signal to finish script to avoid halting container if the built-in proxy was disabled
    touch /dev/shm/no_built_in_proxy
    # Tell S6-Overlay not to restart this service
    s6-svc -O .
    exit "${__BASHIO_EXIT_OK}"
fi

bashio::log.debug "Merging options & variables for template"
ha_config_file="/homeassistant/configuration.yaml"
ha_port="8123"
ha_ssl="false"
if bashio::fs.file_exists "${ha_config_file}" && yq "${ha_config_file}" >/dev/null; then
    # https://www.home-assistant.io/integrations/http/#http-configuration-variables
    ha_port=$(yq '.http.server_port // 8123' "${ha_config_file}")
    ha_ssl=$(yq '.http | has("ssl_certificate") and has("ssl_key")' "${ha_config_file}")
fi
bashio::log.debug "ha_port: ${ha_port}"
bashio::log.debug "ha_ssl: ${ha_ssl}"
JSON_CONF=$(jq -n \
    --arg port "${ha_port}" \
    --arg ssl "${ha_ssl}" \
    '{port: $port, ssl: ($ssl | fromjson)}')
bashio::log.debug "Generating nginx.conf from template in /etc/nginx/servers/homeassistant.conf"
bashio::log.debug "JSON_CONF: ${JSON_CONF}"
tempio \
    -template /etc/nginx/template/homeassistant.gtpl \
    -out /etc/nginx/servers/homeassistant.conf \
    <<<"${JSON_CONF}"
bashio::log.debug "Generated nginx.conf:"
bashio::log.debug "$(cat /etc/nginx/servers/homeassistant.conf)"

# start server
bashio::log.info "Running nginx..."
exec nginx -c /etc/nginx/nginx.conf
